---
title: "Visualization and Analysis"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---
Loading packages for the plots

```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(plotly)
library(flexdashboard)
library(dplyr)
library(tidyverse)
library(leaflet)
library(knitr)
```

# Reading in Cleaned Data 

```{r, message=FALSE, warning=FALSE}
alcohol_data_2007 = read_csv("./data/PRAM_2007_alcohol.csv")

tobacco_data_2007 = read_csv("./data/PRAM_2007_tobacco.csv")

no_contraception_data_2007 = read_csv("./data/PRAM_2007_no_contraception.csv")

infant_mortality_df = read_csv("./data/PRAM_2007_infantmortality.csv")

maternal_race = read_csv("./data/PRAM_2007_Maternal_Race.csv")

# cleaned alcohol data 
cleaned_alc_2007 <- alcohol_data_2007 |>
  janitor::clean_names() |>
  select(-data_value_std_err, -data_value_type) |>
  filter(response != "DRINKER WHO QUIT") |>
  filter(response != "NONDRINKER") |>
  filter( response != "NO") |>
  drop_na(response,geolocation) |>
  separate(geolocation, into = c("latitude", "longitude"), sep = ", ", convert = TRUE) |>
   mutate(latitude = as.numeric(str_replace_all(latitude, "\\(|\\)", "")),  # Convert to numeric and remove parentheses
         longitude = as.numeric(str_replace_all(longitude, "\\(|\\)", "")))  # Convert to numeric and remove parentheses

# cleaned tobacco data 

cleaned_tobac_2007 <- tobacco_data_2007 |>
  janitor::clean_names() |>
  select(-data_value_type) |>
  filter(response != "SMOKER WHO QUIT") |>
  filter(response != "NONSMOKER") |>
  filter(response != "None (0 cig)") |>
  filter( response != "NO") |>
  drop_na(response, geolocation) |>
  separate(geolocation, into = c("latitude", "longitude"), sep = ", ", convert = TRUE) |>
   mutate(latitude = as.numeric(str_replace_all(latitude, "\\(|\\)", "")),  # Convert to numeric and remove parentheses
         longitude = as.numeric(str_replace_all(longitude, "\\(|\\)", "")))  # Convert to numeric and remove parentheses

cleaned_mat_race <- maternal_race |>
  janitor::clean_names() |>
  select(-data_value_std_err, -data_value_type) |>
  drop_na(response,geolocation) |>
  separate(geolocation, into = c("latitude", "longitude"), sep = ", ", convert = TRUE) |>
   mutate(latitude = as.numeric(str_replace_all(latitude, "\\(|\\)", "")),  # Convert to numeric and remove parentheses
         longitude = as.numeric(str_replace_all(longitude, "\\(|\\)", "")))  # Convert to numeric and remove parentheses
  
no_alcohol_data_2007 = read_csv("./data/PRAM_2007_no_alcohol.csv")

no_tobacco_data_2007 = read_csv("./data/PRAM_2007_no_tobacco.csv")

contraception_data_2007 = read_csv("./data/PRAM_2007_contraception.csv")

# cleaned no alcohol data 

cleaned_no_alc_2007 <- no_alcohol_data_2007 |>
  janitor::clean_names() |>
  select(-data_value_std_err, -geolocation, -data_value_type) |>
  drop_na(response)

view(cleaned_no_alc_2007)

# cleaned no tobacco data 

cleaned_no_tobacco_2007 <- no_tobacco_data_2007 |>
  janitor::clean_names() |>
  select(-data_value_std_err, -geolocation, -data_value_type) |>
  drop_na(response)

# cleaned infant mortality 

cleaned_infant_mortality <- infant_mortality_df |>
  janitor::clean_names() |>
  select(-data_value_std_err, -data_value_type, -data_value_unit, -data_value_footnote_symbol, -data_value_footnote) |>
  drop_na(response, geolocation) |>
  separate(geolocation, into = c("latitude", "longitude"), sep = ", ", convert = TRUE) |>
   mutate(latitude = as.numeric(str_replace_all(latitude, "\\(|\\)", "")),  # Convert to numeric and remove parentheses
         longitude = as.numeric(str_replace_all(longitude, "\\(|\\)", "")))  # Convert to numeric and remove parentheses

# cleaned conception

cleaned_contraception_2007 <- contraception_data_2007 |>
  janitor::clean_names() |>
  select(-data_value_std_err, -geolocation, -data_value_type) |>
  filter(response != "YES (CHECKED)") |>
  filter(response != "YES") |>
  drop_na(response)

# cleaned non conception

cleaned_no_contra_2007 <- no_contraception_data_2007 %>%
  janitor::clean_names() %>%
  select(-data_value_type) %>%
  drop_na(response) |>
  separate(geolocation, into = c("latitude", "longitude"), sep = ", ", convert = TRUE) |>
   mutate(latitude = as.numeric(str_replace_all(latitude, "\\(|\\)", "")),  # Convert to numeric and remove parentheses
         longitude = as.numeric(str_replace_all(longitude, "\\(|\\)", "")))  # Convert to numeric and remove parentheses

```





Plot 1: Alcohol Consumption in relation to Infant Mortality
```{r, message=FALSE, warning=FALSE}


# Plot of question and responses for alcohol

# Create ggplot object
gg_plot <- cleaned_alc_2007 %>%
  ggplot(aes(x = question, fill = response)) +
  geom_bar(position = "dodge") +
  labs(title = "Questions and Responses", x = "Questions", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 5, size = 2)) +
  labs(
    x = "Question",
    y = "Response",
    title = "Questions vs Response of Alcohol Consumption"
  )

# Extract data directly from the original data frame
plot_data <- cleaned_alc_2007 %>%
  group_by(question, response) %>%
  summarize(count = n())

# Convert data to Plotly
plot_ly(data = plot_data, x = ~question, y = ~count, color = ~response, type = "bar", split = ~response) %>%
  layout(
    title = "Questions vs Response of Alcohol Consumption",
    xaxis = list(title = "Question",tickfont = list(size = 5)),
    yaxis = list(title = "Response"),
    barmode = "stack"
  )

```

Plot 2: Tobacco Plots

```{r}
library(ggplot2)
library(plotly)
library(dplyr)

# Assuming cleaned_tobac_2007 is a data frame
# If not, convert it to a data frame using as.data.frame()

# Create ggplot object
gg_plot <- cleaned_tobac_2007 %>%
  ggplot(aes(x = location_abbr, fill = response)) +
  geom_bar(position = "dodge") +
  labs(title = "Questions and Responses", x = "Questions", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    x = "Question",
    y = "Response",
    title = "Tobacco Use by State"
  )

# Extract data directly from the original data frame
plot_data <- cleaned_tobac_2007 %>%
  group_by(location_abbr, response) %>%
  summarize(count = n())

# Convert data to Plotly
plot_ly(data = plot_data, x = ~location_abbr, y = ~count, color = ~response, type = "bar", split = ~response) %>%
  layout(
    title = " Tobacco Use by State",
    xaxis = list(title = "Question"),
    yaxis = list(title = "Response"),
    barmode = "stack"
  )

```





### Map of Maternal Alcohol Use

```{r, message=FALSE, warning=FALSE}
leaflet() |> 
  addTiles() |> 
  addCircleMarkers(data = cleaned_alc_2007,
                   lng = ~longitude,  # Adjust column name if needed
                   lat = ~latitude,   # Adjust column name if needed
                   label = ~location_abbr,   # Assuming 'Group.1' is a column in your data
                   radius = ~data_value * 0.12,
                   color = "blue",
                   stroke = TRUE,
                   fillOpacity = 0.1,
                   popup = ~paste("Response:", response)) 
```

### Map of Maternal Tobacco use

```{r, message=FALSE, warning=FALSE}
leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = cleaned_tobac_2007,
                   lng = ~longitude,  
                   lat = ~latitude,   
                   label = ~location_abbr,   
                   radius = ~data_value * 0.12,
                   color = "magenta",
                   stroke = TRUE,
                   fillOpacity = 0.1,
                   popup = ~paste("Response:", response),
                   group = ~location_abbr)
```


### Map of Infant Mortality Rate

```{r}
leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = cleaned_infant_mortality,
                   lng = ~longitude,
                   lat = ~latitude,
                   label = ~location_abbr,
                   radius = ~data_value * 0.12,
                   color = "orange",
                   stroke = TRUE,
                   fillOpacity = 0.5,
                   popup = ~paste("Response:", response))
```

#### States with the most infant mortality rates 

The plot above shows the locations of infant mortality rate across the US. 

```{r}
infant_deaths <- cleaned_infant_mortality %>%
  filter(question == "Indicator of infant currently alive" & response == "NO") %>%
  group_by(location_desc) %>%
  summarize(total_infant_deaths = n())

# Display the table using knitr::kable()
knitr::kable(infant_deaths)

```


The table provides a summary of total infant deaths by state, with each row representing a specific location. The `location_desc` column denotes the state, and the `total_infant_deaths` column indicates the corresponding number of infant deaths in each location. The data suggests variability in infant mortality rates across different regions, with some areas reporting higher or lower rates than others. For instance, states like Pennsylvania have a notably lower count of infant deaths, while others, such as Alaska and Arkansas, have higher counts. However, most of the data seemed to stay within the 35 to 50 range. This summary provides an overview of the distribution of infant deaths across various geographical locations. 


# Plot of Infant Mortality and Race/Ethnicity

```{r}
filtered_mortality_race <- cleaned_infant_mortality %>%
  filter(break_out_category == "Maternal Race/Ethnicity" &
         (break_out %in% c("Hispanic", "Non-hispanic", "White, non-Hispanic")) &
         question == "Indicator of infant currently alive" & response == "NO")

# Display the table using knitr::kable()
knitr::kable(filtered_mortality_race)

view(filtered_mortality_race)

plot_infant_deaths <- ggplot(filtered_mortality_race, aes(x = break_out, fill = break_out)) +
  geom_bar() +
  labs(title = "Infant Deaths by Ethnicity",
       x = "Ethnicity",
       y = "Total Infant Deaths") +
  scale_fill_manual(values = c("Hispanic" = "blue", "Non-hispanic" = "green", "White, non-Hispanic" = "pink")) +
  theme_minimal()

print(plot_infant_deaths)
```

The `plot_infant_deaths` above shows a plot of infant deaths categorized by whether they were Hispanic or not. The graph shows that those who were not Hispanic had a higher infant death count than those who were Hispanic.

#Plot of Infant Mortality and Maternal Income

```{r}

filtered_mortality_income <- cleaned_infant_mortality %>%
  filter(break_out_category == "Income (years 2004 and beyond)" &
         (break_out %in% c("Less than $10,000", "$25,000 to $49,999", "$50,000 or more")) &
         question == "Indicator of infant currently alive" & response == "NO")

view(filtered_mortality_income)

plot_infant_income <- ggplot(filtered_mortality_income, aes(x = break_out, fill = break_out)) +
  geom_bar() +
  labs(title = "Infant Deaths by Income",
       x = "Income",
       y = "Total Infant Deaths") +
  scale_fill_manual(values = c("Less than $10,000" = "blue", "$25,000 to $49,999" = "purple", "$50,000 or more" = "pink")) +
  theme_minimal()

print(plot_infant_income)

```


# creating a linear regression
```{r}
merged_data <- left_join(cleaned_alc_2007, cleaned_infant_mortality, by = "year") %>%
  select(location_abbr.x, location_abbr.y, location_desc.x, location_desc.y, topic.x, topic.y, question.x, response.x, class.y, topic.y, question.y, break_out_category.y, response.y)
```

